resources:
- name: boomi-cloudbuild
  action: gcp-types/cloudbuild-v1:cloudbuild.projects.builds.create
  metadata:
    runtimePolicy:
    - UPDATE_ALWAYS
  properties:
    timeout: 120s
    steps:
    - id: git_clone
      name: 'gcr.io/cloud-builders/git'
      args:
      - clone
      - https://github.com/vilvamani/gcp-deployment-manager.git

    - id: 'build_image'
      name: 'gcr.io/cloud-builders/docker'
      args: ['build', '--tag=gcr.io/$PROJECT_ID/helm:${_HELM_VERSION}', '--tag=gcr.io/$PROJECT_ID/helm:latest', '--build-arg', 'HELM_VERSION=v${_HELM_VERSION}', '.']
      dir: gcp-deployment-manager/kubernetes

    - id: helm_secret_deployment
      name: 'gcr.io/$PROJECT_ID/helm:latest'
      args: 
        - install
        - --generate-name
        - --namespace
        - default
        - --set
        - secrets.username=vilvamani007@gmail.com,secrets.password=abc,secrets.account=abc,volume.server=10.0.0.8
        - -f
        - ./values.yaml
      dir: gcp-deployment-manager/kubernetes/helm
      env:
        - CLOUDSDK_COMPUTE_REGION=us-central1
        - CLOUDSDK_CONTAINER_CLUSTER=boomi-qs-gke-cluster
        - KUBECONFIG=/workspace/.kube/config

    substitutions:
      _HELM_VERSION: 3.2.0