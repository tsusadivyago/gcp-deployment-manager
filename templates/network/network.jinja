{% set project = env["project"] %}
{% set deployment = env["deployment"] %}
{% set region = properties["region"] %}
{% set vpcName = properties["vpcName"] %}
{% set publicSubnet= properties["publicSubnetName"] %}
{% set privateSubnet= properties["privateSubnetName"] %}
{% set publicSubnetCIDR = properties["publicSubnetCIDR"] %}
{% set privateSubnetCIDR = properties["privateSubnetCIDR"] %}

resources:
# GCP Custom Network
- name: {{ vpcName }}
  type: compute.v1.network
  properties:
    name: {{ vpcName }}
    autoCreateSubnetworks: false

# GCP Public Subnets
- name: {{ publicSubnet }}
  type: compute.v1.subnetwork
  properties:
    name: {{ publicSubnet }}
    network: $(ref.{{ vpcName }}.selfLink)
    ipCidrRange: {{ publicSubnetCIDR }}
    region: {{ region }}
    enableFlowLogs: true

# GCP Private Subnets
- name: {{ privateSubnet }}
  type: compute.v1.subnetwork
  properties:
    name: {{ privateSubnet }}
    network: $(ref.{{ vpcName }}.selfLink)
    ipCidrRange: {{ privateSubnetCIDR }}
    region: {{ region }}
    enableFlowLogs: true

# GCP Firewall Rules
- name: {{ deployment + '-firewall-allow-ssh-rdp' }}
  type: compute.v1.firewall
  properties:
    name: {{ deployment + '-firewall-allow-ssh-rdp' }}
    network: $(ref.{{ vpcName }}.selfLink)
    sourceRanges: ["0.0.0.0/0"]
    allowed:
    - IPProtocol: TCP
      ports: [22, 3389]
    targetTags: 
    - allow-ssh-rpd
    logConfig:
      enable: true

- name: {{ deployment + '-firewall-allow-http-https' }}
  type: compute.v1.firewall
  properties:
    name: {{ deployment + '-firewall-allow-http-https' }}
    network: $(ref.{{ vpcName }}.selfLink)
    sourceRanges: ["0.0.0.0/0"]
    allowed:
    - IPProtocol: TCP
      ports: [80, 443]
    logConfig:
      enable: true

- name: {{ deployment + '-firewall-allow-icmp' }}
  type: compute.v1.firewall
  properties:
    name: {{ deployment + '-firewall-allow-icmp' }}
    network: $(ref.{{ vpcName }}.selfLink)
    sourceRanges: ["0.0.0.0/0"]
    allowed:
    - IPProtocol: ICMP
      ports: []
    logConfig:
      enable: true

- name: {{ deployment }}-route
  type: compute.v1.route
  properties:
    name: {{ deployment }}-route
    description: route with default internet gateway
    network: $(ref.{{ vpcName }}.selfLink)
    priority: 1
    destRange: 0.0.0.0/0
    nextHopGateway: https://www.googleapis.com/compute/v1/projects/{{ env["project"] }}/global/gateways/default-internet-gateway


- name: {{ deployment }}-{{ region }}-cloud-router
  type: compute.v1.router
  properties:
    name: {{ deployment }}-{{ region }}-cloud-router
    description: route with default internet gateway
    network: $(ref.{{ vpcName }}.selfLink)
    region: {{ region }}
    nats:
    - name: {{ deployment }}-{{ region }}-nat
      natIpAllocateOption: "AUTO_ONLY"
      sourceSubnetworkIpRangesToNat: "LIST_OF_SUBNETWORKS"
      subnetworks: 
      - name: $(ref.{{ privateSubnet }}.selfLink)
        sourceIpRangesToNat: ["PRIMARY_IP_RANGE"]