{% set project = env["project"] %}
{% set deployment = env["deployment"] %}

{% set region = properties["region"] %}
{% set vpcName = deployment + "-network" %}
{% set publicSubnet = deployment + "-" +  region  + '-public-subnet' %}
{% set privateSubnet = deployment + "-" +  region + '-private-subnet' %}

resources:
# GCP Custom Network
- name: {{ vpcName }}
  type: compute.v1.network
  properties:
    name: {{ vpcName }}
    description: {{ vpcName }}
    autoCreateSubnetworks: {{ properties["autoCreateSubnetworks"] }}

{% if not properties["autoCreateSubnetworks"] %}
# GCP Public Subnets
- name: {{ publicSubnet }}
  type: compute.v1.subnetwork
  properties:
    name: {{ publicSubnet }}
    description: {{ publicSubnet }}
    network: $(ref.{{ vpcName }}.selfLink)
    region: {{ properties["region"] }}
    ipCidrRange: {{ properties["publicSubnetCidrRange"] }}
    enableFlowLogs: {{ properties["enableFlowLogs"] }}

# GCP Private Subnets
- name: {{ privateSubnet }}
  type: compute.v1.subnetwork
  properties:
    name: {{ privateSubnet }}
    description: {{ publicSubnet }}
    network: $(ref.{{ vpcName }}.selfLink)
    region: {{ properties["region"] }}
    ipCidrRange: {{ properties["privateSubnetCidrRange"] }}
    enableFlowLogs: {{ properties["enableFlowLogs"] }}
    privateIpGoogleAccess: {{ properties["privateIpGoogleAccess"] }}
{% endif %}

# GCP Firewall Rules
- name: {{ deployment + '-allow-ssh-rdp' }}
  type: compute.v1.firewall
  properties:
    name: {{ deployment + '-allow-ssh-rdp' }}
    description: {{ deployment + '-allow-ssh-rdp' }}
    network: $(ref.{{ vpcName }}.selfLink)
    sourceRanges: ["0.0.0.0/0"]
    allowed:
    - IPProtocol: TCP
      ports: [22, 3389]
    targetTags: 
    - allow-ssh-rpd
    logConfig:
      enable: true

- name: {{ deployment + '-allow-http-https' }}
  type: compute.v1.firewall
  properties:
    name: {{ deployment + '-allow-http-https' }}
    description: {{ deployment + '-allow-http-https' }}
    network: $(ref.{{ vpcName }}.selfLink)
    sourceRanges: ["0.0.0.0/0"]
    allowed:
    - IPProtocol: TCP
      ports: [80, 443]
    logConfig:
      enable: true

- name: {{ deployment + '-allow-icmp' }}
  type: compute.v1.firewall
  properties:
    name: {{ deployment + '-allow-icmp' }}
    description: {{ deployment + '-allow-icmp' }}
    network: $(ref.{{ vpcName }}.selfLink)
    sourceRanges: ["0.0.0.0/0"]
    allowed:
    - IPProtocol: ICMP
      ports: []
    logConfig:
      enable: true

- name: {{ deployment }}-ingress-static-ip
  type: compute.v1.globalAddress
  properties:
    name: {{ deployment }}-ingress-static-ip
    description: {{ deployment }}-ingress-static-ip
    ipVersion: IPV4
    networkTier: PREMIUM

outputs:
- name: VpcName
  value: $(ref.{{ vpcName }}.name)

- name: VpcSelfLink
  value: $(ref.{{ vpcName }}.selfLink)

{% if properties["autoCreateSubnetworks"] %}
- name: PrivateSubnetRef
  value: $(ref.{{ privateSubnet }}.selfLink)

- name: PublicSubnetRef
  value: $(ref.{{ publicSubnet }}.selfLink)
{% endif %}

- name: ingressStaticIpName
  value: $(ref.{{ deployment + '-ingress-static-ip' }}.name)