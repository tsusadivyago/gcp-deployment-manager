{% set project = env["project"] %}
{% set deployment = env["deployment"] %}
{% set REGION = properties["region"] %}
{% set VPC_NAME = "%s-gke-network" % env["deployment"] %}
{% set PUBLIC_SUBNET_NAME = "public" %}
{% set PRIVATE_SUBNET_NAME = "private" %}
{% set publicSubnetCIDR = properties["publicSubnetCIDR"] %}
{% set privateSubnetCIDR = properties["privateSubnetCIDR"] %}
{% set CLUSTER_NAME = deployment + '-gke-cluster' %}


resources:
- name: boomi-gke-network
  type: network.jinja
  properties:
    region: {{ REGION }}
    vpcName: {{ VPC_NAME }}
    publicSubnetName: {{ PUBLIC_SUBNET_NAME }}
    privateSubnetName: {{ PRIVATE_SUBNET_NAME }}
    publicSubnetCIDR: {{ publicSubnetCIDR }}
    privateSubnetCIDR: {{ privateSubnetCIDR }}

- name: boomi-gke-cluster
  type: gke.jinja
  properties:
    region: {{ properties["region"] }}
    zone: {{ properties["zone"] }}
    network: $(ref.{{ VPC_NAME }}.selfLink)
    subnet: $(ref.{{ PRIVATE_SUBNET_NAME }}.selfLink)

    # Set this to v1beta1 to use beta features such as private clusters
    gkeApiVersion: {{ properties["gkeApiVersion"] }}
    pool-version: v1

    # Whether to deploy the new Stackdriver Kubernetes agents
    stackdriver-kubernetes: false

    desiredNodeCount: {{ properties["desiredNodeCount"] }}
    minNodeCount: {{ properties["minNodeCount"] }}
    maxNodeCount: {{ properties["maxNodeCount"] }}

    gkeMachineType: {{ properties["gkeMachineType"] }}

    securityConfig:
      privatecluster: {{ properties["privatecluster"] }}
      masterIpv4CidrBlock: 172.16.0.16/28
      secureNodeMetadata: true
      podSecurityPolicy: true
      masterAuthorizedNetworksConfig:
        cidrBlocks:
        - cidrBlock: 1.2.3.4/32
        - cidrBlock: 5.6.7.8/32
        enabled: true
        
- name: file-store
  type: file-store.jinja
  properties:
    zone: {{ properties["zone"] }}
    network: {{ VPC_NAME }}
    size: 1024

- name: boomi-cloudbuild
  type: cloudbuild.jinja
  properties:
    build_steps:
      # Step 1
      - name: 'gcr.io/cloud-builders/kubectl'
        args:
          - cluster-info
        env:
          - CLOUDSDK_COMPUTE_REGION={{ REGION }}
          - CLOUDSDK_CONTAINER_CLUSTER={{ CLUSTER_NAME }}
          - KUBECONFIG=/workspace/.kube/config

      # Step 2
      - name: 'gcr.io/cloud-builders/kubectl'
        args:
          - apply
          - --filename=https://raw.githubusercontent.com/ikanski/EKS/master/config/boomi_molecule_eks_service.yaml
        env:
          - CLOUDSDK_COMPUTE_REGION={{ REGION }}
          - CLOUDSDK_CONTAINER_CLUSTER={{ CLUSTER_NAME }}
          - KUBECONFIG=/workspace/.kube/config

#- name: boomi-secret
#  type: secret.jinja
#  metadata:
#    dependsOn:
#      - boomi-gke-cluster

#- name: boomi-pvc
#  type: persistentvolumeclaim.jinja
#  metadata:
#    dependsOn:
#      - boomi-gke-cluster

#- name: boomi-bastion
#  type: bastion.jinja
#  properties:
#    region: {{ REGION }}
#    zone: {{ properties["zone"] }}
#    network: $(ref.{{ VPC_NAME }}.selfLink)
#    subnet: $(ref.{{ PUBLIC_SUBNET_NAME }}.selfLink)
#    machineType: {{ properties["machineType"] }}
#    machineImage: {{ properties["machineImage"] }}
#    targetSize: {{ properties["targetSize"] }}
#  metadata:
#    dependsOn:
#      - boomi-gke-network
#      - boomi-gke-cluster


